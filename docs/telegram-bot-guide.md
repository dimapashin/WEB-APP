# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ Telegram-–±–æ—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotFather
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook/Polling
3. –õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
4. –õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –≥–æ—Å—Ç—è
5. –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

---

## 1. –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather

### –®–∞–≥–∏:

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ `@BotFather`
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/newbot`
3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º:
   - –í–≤–µ–¥–∏—Ç–µ –∏–º—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "VIDI Hotel Concierge")
   - –í–≤–µ–¥–∏—Ç–µ username –±–æ—Ç–∞ (–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `bot`, –Ω–∞–ø—Ä–∏–º–µ—Ä: `vidi_hotel_bot`)
4. BotFather –≤–µ—Ä–Ω–µ—Ç –≤–∞–º **—Ç–æ–∫–µ–Ω –±–æ—Ç–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä: `8594370320:AAH-...`)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: `TELEGRAM_BOT_TOKEN`

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

```
/setdescription - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞
/setabouttext - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç "–û –±–æ—Ç–µ"
/setuserpic - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
/setcommands - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
```

–ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥:
```
start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
status - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
help - –ü–æ–º–æ—â—å
```

---

## 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook / Polling

### –í–∞—Ä–∏–∞–Ω—Ç –ê: Polling (–ø—Ä–æ—â–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ë–æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É Telegram API –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—â–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å (–Ω–µ –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π URL)
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ú–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –±–æ—Ç–æ–≤
- –î–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ

### –í–∞—Ä–∏–∞–Ω—Ç –ë: Webhook (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)

**–ü—Ä–∏–Ω—Ü–∏–ø:** Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ HTTP POST.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π HTTPS URL
- –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å

---

## 3. –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞: –ë–∞–∑–æ–≤—ã–π –±–æ—Ç –Ω–∞ Node.js

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install node-telegram-bot-api
# –∏–ª–∏
npm install telegraf  # –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
```

### –í–∞—Ä–∏–∞–Ω—Ç 1: node-telegram-bot-api (Polling)

```typescript
// bot/telegramBot.ts
import TelegramBot from 'node-telegram-bot-api';

const token = process.env.TELEGRAM_BOT_TOKEN!;
const bot = new TelegramBot(token, { polling: true });

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from?.id;

  await bot.sendMessage(
    chatId,
    `üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VIDI Hotel!\n\n` +
    `–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–π –∫–æ–º–Ω–∞—Ç—ã:`
  );

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –∂–¥–µ–º –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã
  // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Map –∏–ª–∏ –ë–î –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
  userStates.set(userId!, 'waiting_room');
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã)
bot.on('message', async (msg) => {
  const userId = msg.from?.id;
  const chatId = msg.chat.id;
  const text = msg.text;

  if (!text || text.startsWith('/')) return;

  const state = userStates.get(userId!);

  if (state === 'waiting_room') {
    const roomNumber = text.trim();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–∞ –∫–æ–º–Ω–∞—Ç—ã
    if (!/^\d{3,4}$/.test(roomNumber)) {
      await bot.sendMessage(
        chatId,
        '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ –∫–æ–º–Ω–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:'
      );
      return;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤—è–∑–∏ telegram_id ‚Üî room_number
    await saveUserTelegramId(userId!, roomNumber);

    userStates.delete(userId!);

    await bot.sendMessage(
      chatId,
      `‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã ${roomNumber} –ø—Ä–∏–≤—è–∑–∞–Ω.\n\n` +
      `–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–∞—à–∏—Ö –∑–∞–∫–∞–∑–∞—Ö.`
    );
  }
});

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π (–≤ production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis –∏–ª–∏ –ë–î)
const userStates = new Map<number, string>();
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Telegraf (–±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π)

```typescript
// bot/telegramBot.ts
import { Telegraf, Context } from 'telegraf';

const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN!);

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
interface Session {
  state: 'waiting_room' | null;
  roomNumber?: string;
}

const sessions = new Map<number, Session>();

// Middleware –¥–ª—è —Å–µ—Å—Å–∏–π
bot.use(async (ctx, next) => {
  const userId = ctx.from?.id;
  if (userId && !sessions.has(userId)) {
    sessions.set(userId, { state: null });
  }
  await next();
});

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.command('start', async (ctx: Context) => {
  const userId = ctx.from!.id;
  sessions.set(userId, { state: 'waiting_room' });

  await ctx.reply(
    `üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VIDI Hotel!\n\n` +
    `–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–π –∫–æ–º–Ω–∞—Ç—ã:`
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
bot.on('text', async (ctx: Context) => {
  const userId = ctx.from!.id;
  const session = sessions.get(userId);

  if (session?.state === 'waiting_room') {
    const roomNumber = ctx.message.text.trim();

    if (!/^\d{3,4}$/.test(roomNumber)) {
      await ctx.reply('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ –∫–æ–º–Ω–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:');
      return;
    }

    await saveUserTelegramId(userId, roomNumber);
    sessions.set(userId, { state: null, roomNumber });

    await ctx.reply(
      `‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã ${roomNumber} –ø—Ä–∏–≤—è–∑–∞–Ω.\n\n` +
      `–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–∞—à–∏—Ö –∑–∞–∫–∞–∑–∞—Ö.`
    );
  }
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch();

// Graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
```

---

## 4. –õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

### –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø—É

```typescript
// services/telegramNotification.ts
import TelegramBot from 'node-telegram-bot-api';

const bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN!);
const ADMIN_GROUP_ID = process.env.TELEGRAM_ADMIN_GROUP_ID!; // ID –≥—Ä—É–ø–ø—ã –∞–¥–º–∏–Ω–æ–≤

interface OrderData {
  id: string;
  type: 'breakfast' | 'wakeup' | 'taxi' | 'restaurant';
  guestName: string;
  roomNumber: string;
  date?: string;
  time?: string;
  details: string;
  items?: Array<{ name: string; quantity: number; price: number }>;
}

const orderTypeEmoji: Record<string, string> = {
  breakfast: 'ü•ê',
  wakeup: '‚è∞',
  taxi: 'üöï',
  restaurant: 'üçΩÔ∏è',
};

export async function notifyAdmins(order: OrderData): Promise<void> {
  const emoji = orderTypeEmoji[order.type] || 'üìã';
  
  let message = `üîî <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó #${order.id}</b>\n\n`;
  message += `${emoji} <b>–¢–∏–ø:</b> ${getOrderTypeName(order.type)}\n`;
  message += `üë§ <b>–ì–æ—Å—Ç—å:</b> ${order.guestName}\n`;
  message += `üè® <b>–ù–æ–º–µ—Ä:</b> ${order.roomNumber}\n`;
  
  if (order.date) {
    message += `üìÖ <b>–î–∞—Ç–∞:</b> ${order.date}\n`;
  }
  
  if (order.time) {
    message += `üïê <b>–í—Ä–µ–º—è:</b> ${order.time}\n`;
  }
  
  message += `\nüìù <b>–î–µ—Ç–∞–ª–∏:</b> ${order.details}\n`;
  
  if (order.items && order.items.length > 0) {
    message += `\n<b>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</b>\n`;
    order.items.forEach(item => {
      message += `‚Ä¢ ${item.name} x${item.quantity} - ${item.price * item.quantity} ‚ÇΩ\n`;
    });
  }
  
  message += `\n‚è± <i>–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è:</i> ${new Date().toLocaleString('ru-RU')}`;

  try {
    await bot.sendMessage(ADMIN_GROUP_ID, message, {
      parse_mode: 'HTML',
      disable_notification: false,
    });
    
    console.log(`[Telegram] Notification sent to admin group for order ${order.id}`);
  } catch (error) {
    console.error(`[Telegram] Failed to send notification:`, error);
    throw error;
  }
}

function getOrderTypeName(type: string): string {
  const names: Record<string, string> = {
    breakfast: '–ó–∞–≤—Ç—Ä–∞–∫',
    wakeup: '–ë—É–¥–∏–ª—å–Ω–∏–∫',
    taxi: '–¢–∞–∫—Å–∏',
    restaurant: '–†–µ—Å—Ç–æ—Ä–∞–Ω',
  };
  return names[type] || type;
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å backend (–ø—Ä–∏–º–µ—Ä)

```typescript
// routes/orders.ts (Express)
import { notifyAdmins } from '../services/telegramNotification';

router.post('/orders', authenticateToken, async (req, res) => {
  const userId = req.user.id;
  const { type, details, orderDate, orderTime, items } = req.body;

  // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –ë–î
  const order = await prisma.order.create({
    data: {
      user_id: userId,
      type,
      details,
      order_date: orderDate ? new Date(orderDate) : null,
      order_time: orderTime || null,
      status: 'pending',
      items: items ? {
        create: items.map((item: any) => ({
          item_id: item.id,
          item_name: item.name,
          price: item.price,
          quantity: item.quantity,
        }))
      } : undefined,
    },
    include: {
      user: true,
      items: true,
    }
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º
  try {
    await notifyAdmins({
      id: order.id,
      type: order.type as any,
      guestName: order.user.name,
      roomNumber: order.user.room_number,
      date: order.order_date?.toISOString().split('T')[0],
      time: order.order_time,
      details: order.details,
      items: order.items.map(item => ({
        name: item.item_name,
        quantity: item.quantity,
        price: Number(item.price),
      })),
    });
  } catch (error) {
    console.error('Failed to notify admins:', error);
    // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º
  }

  res.json({ order });
});
```

---

## 5. –õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –≥–æ—Å—Ç—è

### –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≥–æ—Å—Ç—é

```typescript
// services/telegramNotification.ts (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)

export async function notifyGuest(
  telegramId: number,
  message: string,
  options?: { parse_mode?: 'HTML' | 'Markdown' }
): Promise<void> {
  try {
    await bot.sendMessage(telegramId, message, {
      parse_mode: options?.parse_mode || 'HTML',
      disable_notification: false,
    });
    
    console.log(`[Telegram] Notification sent to guest ${telegramId}`);
  } catch (error: any) {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞, –æ—à–∏–±–∫–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞
    if (error.response?.body?.error_code === 403) {
      console.warn(`[Telegram] Guest ${telegramId} blocked the bot`);
      return;
    }
    console.error(`[Telegram] Failed to send notification to guest:`, error);
    throw error;
  }
}

export async function notifyGuestOrderConfirmation(
  telegramId: number,
  order: OrderData
): Promise<void> {
  const emoji = orderTypeEmoji[order.type] || 'üìã';
  
  let message = `‚úÖ <b>–í–∞—à –∑–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</b>\n\n`;
  message += `${emoji} <b>${getOrderTypeName(order.type)}</b>\n`;
  message += `üè® –ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã: ${order.roomNumber}\n`;
  
  if (order.date) {
    message += `üìÖ –î–∞—Ç–∞: ${order.date}\n`;
  }
  
  if (order.time) {
    message += `üïê –í—Ä–µ–º—è: ${order.time}\n`;
  }
  
  message += `\nüìù ${order.details}\n`;
  message += `\nüîî –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å, –∫–æ–≥–¥–∞ –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.`;

  await notifyGuest(telegramId, message);
}

export async function notifyGuestOrderStatus(
  telegramId: number,
  orderId: string,
  status: 'confirmed' | 'completed' | 'cancelled'
): Promise<void> {
  const statusMessages = {
    confirmed: '‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –∏ –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É.',
    completed: 'üéâ –í–∞—à –∑–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—à–∏—Ö —É—Å–ª—É–≥.',
    cancelled: '‚ùå –í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–µ—Å–µ–ø—à–µ–Ω–æ–º.',
  };

  const message = `<b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ #${orderId}</b>\n\n${statusMessages[status]}`;

  await notifyGuest(telegramId, message);
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≥–æ—Å—Ç—é –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

```typescript
// routes/orders.ts (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)
import { notifyAdmins, notifyGuestOrderConfirmation } from '../services/telegramNotification';

router.post('/orders', authenticateToken, async (req, res) => {
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ...

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º
  await notifyAdmins({ ... });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≥–æ—Å—Ç—é, –µ—Å–ª–∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å telegram_id
  if (order.user.telegram_id) {
    try {
      await notifyGuestOrderConfirmation(
        Number(order.user.telegram_id),
        {
          id: order.id,
          type: order.type as any,
          guestName: order.user.name,
          roomNumber: order.user.room_number,
          date: order.order_date?.toISOString().split('T')[0],
          time: order.order_time,
          details: order.details,
          items: order.items.map(item => ({
            name: item.item_name,
            quantity: item.quantity,
            price: Number(item.price),
          })),
        }
      );
    } catch (error) {
      console.error('Failed to notify guest:', error);
      // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞
    }
  }

  res.json({ order });
});
```

### –ü—Ä–∏–º–µ—Ä: –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞

```typescript
// bot/telegramBot.ts (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)

bot.onText(/\/status/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from?.id;

  // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
  const user = await getUserByTelegramId(userId!);

  if (!user) {
    await bot.sendMessage(
      chatId,
      '‚ùå –í—ã –Ω–µ –ø—Ä–∏–≤—è–∑–∞–ª–∏ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞.'
    );
    return;
  }

  // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã
  const orders = await getRecentOrders(user.id, 5);

  if (orders.length === 0) {
    await bot.sendMessage(chatId, 'üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.');
    return;
  }

  let message = `üìã <b>–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã:</b>\n\n`;

  orders.forEach((order, index) => {
    const statusEmoji = {
      pending: '‚è≥',
      confirmed: '‚úÖ',
      completed: 'üéâ',
      cancelled: '‚ùå',
    }[order.status];

    message += `${statusEmoji} <b>–ó–∞–∫–∞–∑ #${order.id.substring(0, 8)}</b>\n`;
    message += `   ${getOrderTypeName(order.type)}\n`;
    message += `   –°—Ç–∞—Ç—É—Å: ${getOrderStatusName(order.status)}\n`;
    if (order.order_date) {
      message += `   –î–∞—Ç–∞: ${order.order_date.toISOString().split('T')[0]}\n`;
    }
    message += `\n`;
  });

  await bot.sendMessage(chatId, message, { parse_mode: 'HTML' });
});
```

---

## 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook (–¥–ª—è production)

### –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Webhook

```typescript
// server.ts
import express from 'express';
import { Telegraf } from 'telegraf';

const app = express();
const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN!);

// Middleware –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
app.use(express.json());

// Webhook endpoint
app.post(`/webhook/${process.env.TELEGRAM_BOT_TOKEN}`, (req, res) => {
  bot.handleUpdate(req.body);
  res.sendStatus(200);
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
bot.telegram.setWebhook(
  `https://yourdomain.com/webhook/${process.env.TELEGRAM_BOT_TOKEN}`
);

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ Bot API –Ω–∞–ø—Ä—è–º—É—é

```bash
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://yourdomain.com/webhook/YOUR_BOT_TOKEN"
  }'
```

---

## 7. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```typescript
bot.on('polling_error', (error) => {
  console.error('Polling error:', error);
});

bot.catch((err, ctx) => {
  console.error('Error in bot:', err);
  ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
});
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ç–∏–ø–∞ `winston` –∏–ª–∏ `pino` –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```typescript
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});

bot.on('message', (msg) => {
  logger.info('Received message', { userId: msg.from?.id, text: msg.text });
});
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–•—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è** - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –≤ –∫–æ–¥
2. **–í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ** - –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–æ–≤ –∫–æ–º–Ω–∞—Ç
3. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ whitelist –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. **Rate limiting** - –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ —á–∞—Å—Ç–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## 8. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)

```
project/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ telegramBot.ts       # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ commands.ts          # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îî‚îÄ‚îÄ handlers.ts          # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ telegramNotification.ts  # –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ user.ts              # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ .env                     # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ package.json
```

---

## 9. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# .env
TELEGRAM_BOT_TOKEN=8594370320:AAH-...
TELEGRAM_ADMIN_GROUP_ID=-1001234567890
DATABASE_URL=postgresql://...
```

---

## –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:

‚úÖ –†–∞–±–æ—á–µ–≥–æ Telegram-–±–æ—Ç–∞ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏  
‚úÖ –°–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤  
‚úÖ –°–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –≥–æ—Å—Ç–µ–π  
‚úÖ –ü—Ä–∏–≤—è–∑–∫—É telegram_id –∫ –Ω–æ–º–µ—Ä—É –∫–æ–º–Ω–∞—Ç—ã  
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞  
‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞  
